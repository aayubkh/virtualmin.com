<script>
    (function () {
        // Define authentication state
        const menu = document.querySelector('#menu'),
            supportItem = document.querySelector('.menu-item--support'),
            signInItem = document.querySelector('.menu-item--singin'),
            userItem = document.querySelector('.menu-item--user'),
            avatar_url = localStorage.getItem("virtualmin-menu-item--user--url");
        if (avatar_url && avatar_url.toString().startsWith('http')) {
            const userAvatar = userItem.querySelector('a > img');
            userAvatar.src = avatar_url;
            userItem.classList.remove('hidden');
            menu.classList.add('menu-authenticated');
            document.documentElement.setAttribute('data-auth', 1);
        } else {
            signInItem.classList.remove('hidden');
            menu.classList.add('menu-unauthenticated');
            document.documentElement.setAttribute('data-auth', 0);
        }
        // https://cdn.forum.virtualmin.com/user_avatar/forum.virtualmin.com/ilia/144/10185_2.png
        if (signInItem && signInItem.classList.contains('hidden')) {
            supportItem.classList.remove('hidden');
        }
    })();
</script>
{{ if eq .RelPermalink "/" }}
<script>
    (function () {
        const $this = {};
        // Sticky header magic
        const header_sticky_class_str = "header-sticky",
            menu_active_class_str = "#menu > li > a.dropdown-menu > span.active",
            scrollFn = function () {
                $this.currentScroll = window.scrollY || document.documentElement.scrollTop;
                $this.lastScroll = 2; // down
                if ($this.currentScroll < $this.lastScrollTop) {
                    $this.lastScroll = 1; // up
                }
                $this.lastScrollTop = $this.currentScroll <= 0 ? 0 : $this.currentScroll;
                const header = document.querySelector(".page-index > body > header"),
                    headerBounds = header.getBoundingClientRect(),
                    headerHeight = headerBounds.height;
                // console.log('Scroll', $this.lastScroll == 2 ? 'down' : 'up', $this.lastScrollTop, headerBounds)
                if (
                    $this.lastScroll === 2 &&
                    headerBounds.top <= 0 &&
                    !header.classList.contains(header_sticky_class_str)
                ) {
                    header.classList.add(header_sticky_class_str);
                    window.scrollBy(window.scrollY, +headerHeight);
                    window.dispatchEvent(new Event("resize")); // reposition dropdown
                } else if (
                    $this.lastScroll === 1 &&
                    document.documentElement.clientHeight - window.scrollY >= 0 &&
                    header.classList.contains(header_sticky_class_str)
                ) {
                    header.classList.remove(header_sticky_class_str);
                    window.scrollBy(window.scrollY, -headerHeight);
                    window.dispatchEvent(new Event("resize")); // reposition dropdown
                }
                if ($this.scrollTimeout) {
                    clearTimeout($this.scrollTimeout);
                }

                $this.scrollTimeout = setTimeout(function () {
                    if (window.scrollY < window.innerHeight) {
                        if (document.querySelector(menu_active_class_str)) {
                            window.dispatchEvent(new Event("resize")); // reposition dropdown
                        }

                        // Auto scroll
                        console.log('trying auto')
                        if ($this.lastScroll === 1) {
                            window.scrollTo({
                                top: 0,
                                left: 0,
                                behavior: 'smooth'
                            });
                        } else if ($this.lastScroll === 2) {
                            window.scrollTo({
                                top: document.documentElement.clientHeight,
                                left: 0,
                                behavior: 'smooth'
                            });
                        }
                    }
                }, 33);
            };
        window.addEventListener("scroll", scrollFn, false);

        // Trigger scroll event on initial load
        window.dispatchEvent(new Event("scroll"));
    })();
</script>
{{ end }}